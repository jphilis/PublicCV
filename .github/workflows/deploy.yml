name: Build and Deploy CV
on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    if: contains(github.event.head_commit.message, 'PUBLISH')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Typst
        # Using the updated community action
        uses: typst-community/setup-typst@v3

      - name: Build CV and Create Landing Page
        run: |
          mkdir public
          # 1. Compile the PDF into the public folder
          typst compile CV_Johan_Philis.typ public/CV_Johan_Philis.pdf
          
          # 2. Create the HTML wrapper
          cat <<EOF > public/index.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CV - Johan Philis</title>
              <style>
                  body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #525659; }
                  iframe { width: 100%; height: 100vh; border: none; }
              </style>
          </head>
          <body>
              <iframe src="CV_Johan_Philis.pdf"></iframe>
          </body>
          </html>
          EOF

          # 3. Add CNAME for domain stuff
          echo "cv.philis.se" > public/CNAME

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
